.deploy_template:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  tags:
    - docker
  script:
    # Docker Host Authentication
    - mkdir -p $DOCKER_CERT_PATH
    - cd $DOCKER_CERT_PATH
    # - cat $CD_$ENV_UPC_CA_PEM > ca.pem &&
    #   cat $CD_$ENV_UPC_CERT_PEM > cert.pem &&
    #   cat $CD_$ENV_UPC_KEY_PEM > key.pem
    - echo $ENV_UPC
    # - export TMP="$ENV_UPC"_CA_PEM && cat ${!TMP} > ca.pem
    # - export TMP="$ENV_UPC"_CERT_PEM && cat ${!TMP} > cert.pem
    # - export TMP="$ENV_UPC"_KEY_PEM && cat ${!TMP} > key.pem
    - export TMP="$ENV_UPC"_CA_PEM
    - echo \$${TMP}
    - echo \$${TMP} > ca.pem
    - export TMP="$ENV_UPC"_CERT_PEM
    - echo \$${TMP}
    - echo \$${TMP} > cert.pem
    - export TMP="$ENV_UPC"_KEY_PEM
    - echo \$${TMP}
    - echo \$${TMP} > key.pem
    - cat ca.pem
    - cat cert.pem
    - cat key.pem
    - ls
    - cd -
    - pwd
    - echo $DOCKER_HOST
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker rm -f $CD_CONTAINER_NAME-$CI_COMMIT_REF_SLUG || true
    - docker compose up -d
    - rm -rf $DOCKER_CERT_PATH
  variables:
    COMPOSE_PROJECT_NAME: geekconsole-$CI_COMMIT_REF_SLUG
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: /certs
    DOCKER_TLS_CERTDIR: ""
